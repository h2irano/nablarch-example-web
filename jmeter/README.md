# README
## テストの内容
- 以下のスレッド数（同時接続ユーザー数）でテストを実行する
    - 1
    - 5
    - 10
    - 50
    - 100
- それぞれのスレッド数で、1回につき3分間 JMeter のテストを5回ずつ実行する
    - 3(minutes) * 5(counts) * 5(patterns)
    - 内訳
        - 1スレッドで3分間テストを5回実行
        - 5スレッドで3分間テストを5回実行
        - 10スレッドで3分間テストを5回実行
        - 50スレッドで3分間テストを5回実行
        - 100スレッドで3分間テストを5回実行
- それぞれのスレッド数で、スループットの中央値を採用する

## 環境準備
### 必要なミドルウェア
- Git Bash
    - bash が動けば他のソフトウェア(cygwin や WSL など)でも問題ないと思うが、検証はしていない
    - ssh, scp が実行できる必要がある
- AWS CLI
    - ver 2+
- JDK
    - ver 11+ (Adopt OpenJDK 推奨)
- Maven
    - ver 3.6.3
- JMeter
    - ver 5.2.1
        - ver 5.3 だと非デーモンスレッドが残り続ける問題を確認している
    - `bin` にパスを通しておくこと

### 事前準備
#### EC2 の鍵登録
- EC2 に SSH で接続できる必要があるので、 ec2-user に鍵を追加しておく
- 秘密鍵はテストを実行するローカルの任意の場所に置いておく

#### AWS CLI の configure
- ECS を AWS CLI を使って起動・停止する必要があるので、権限を持つ IAM ユーザで `aws configure` をしておくこと

#### env.sh の生成
- 初回は以下のコマンドを実行して変数定義ファイル (`env.sh`) を生成させる

```sh
$ ./run-test.sh ec2
```

- `env.sh` というファイルが生成されるので、中に宣言されている変数の値を設定していく

## 実行
```sh
$ ./run-test.sh ec2|ecs
```

- `run-test.sh` を実行する
- 引数に、 `ec2` か `ecs` を指定する
- テストが始まったら `logs/<ec2|ecs>/test_<起動時刻>/<スレッド数>/<試行回数>` の下に結果やログが出力されていく
- 全テスト終了するのに **1時間半程度かかる** ので注意
    - テスト中は、なるべくPCの負荷が高まらないようにしておくのが理想
    - 可能なら、専用端末を用意しておくのが良い
- 全テストが終了すると、 `logs/<ec2|ecs>/test_<起動時刻>/total_throughput.txt` に各ケースでのトータルのスループットがまとめられて出力される
- これを Excel などに張り付ければOK
